import pytest
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from app.database.connection import Base
from app.models.novel import Project, Chapter, Scene
from app.schemas.novel import Project as ProjectSchema, Chapter as ChapterSchema, Scene as SceneSchema

class TestSchemaModelIntegration:
    """Integration tests for schema-database model interaction"""
    
    @pytest.fixture
    def db_session(self):
        """Create a clean database session for each test"""
        engine = create_engine('sqlite:///:memory:')
        Base.metadata.create_all(engine)
        Session = sessionmaker(bind=engine)
        session = Session()
        
        yield session
        
        session.close()
        engine.dispose()
    
    def test_orm_to_schema_conversion_project(self, db_session):
        """Test converting ORM Project model to Pydantic schema"""
        # Create and persist a project
        project_orm = Project(
            title="Test Project",
            author="Test Author",
            genre="Fantasy"
        )
        
        db_session.add(project_orm)
        db_session.commit()
        db_session.refresh(project_orm)
        
        # Convert to Pydantic schema
        project_schema = ProjectSchema.from_orm(project_orm)
        
        # Verify conversion
        assert project_schema.id == project_orm.id
        assert project_schema.title == project_orm.title
        assert project_schema.author == project_orm.author
        assert project_schema.genre == project_orm.genre
        assert project_schema.current_word_count == project_orm.current_word_count
        assert project_schema.is_active == project_orm.is_active
    
    def test_orm_to_schema_conversion_chapter(self, db_session):
        """Test converting ORM Chapter model to Pydantic schema"""
        # Create project and chapter
        project_orm = Project(title="Parent Project")
        chapter_orm = Chapter(title="Test Chapter", order_index=1)
        project_orm.chapters.append(chapter_orm)
        
        db_session.add(project_orm)
        db_session.commit()
        db_session.refresh(chapter_orm)
        
        # Convert to Pydantic schema
        chapter_schema = ChapterSchema.from_orm(chapter_orm)
        
        # Verify conversion
        assert chapter_schema.id == chapter_orm.id
        assert chapter_schema.title == chapter_orm.title
        assert chapter_schema.project_id == chapter_orm.project_id
        assert chapter_schema.order_index == chapter_orm.order_index
        assert chapter_schema.word_count == chapter_orm.word_count
    
    def test_orm_to_schema_conversion_scene(self, db_session):
        """Test converting ORM Scene model to Pydantic schema"""
        # Create project, chapter, and scene
        project_orm = Project(title="Parent Project")
        chapter_orm = Chapter(title="Parent Chapter", order_index=1)
        scene_orm = Scene(title="Test Scene", order_index=1)
        
        project_orm.chapters.append(chapter_orm)
        chapter_orm.scenes.append(scene_orm)
        
        db_session.add(project_orm)
        db_session.commit()
        db_session.refresh(scene_orm)
        
        # Convert to Pydantic schema
        scene_schema = SceneSchema.from_orm(scene_orm)
        
        # Verify conversion
        assert scene_schema.id == scene_orm.id
        assert scene_schema.title == scene_orm.title
        assert scene_schema.chapter_id == scene_orm.chapter_id
        assert scene_schema.order_index == scene_orm.order_index
        assert scene_schema.word_count == scene_orm.word_count
    
    def test_schema_to_orm_compatibility(self, db_session):
        """Test that schema data can be used to create ORM models"""
        from app.schemas.novel import ProjectCreate, ChapterCreate, SceneCreate
        
        # Test ProjectCreate -> ORM Model
        project_data = ProjectCreate(
            title="Schema Project",
            author="Schema Author",
            target_word_count=75000
        )
        
        project_orm = Project(**project_data.dict())
        assert project_orm.title == "Schema Project"
        assert project_orm.author == "Schema Author"
        assert project_orm.target_word_count == 75000
        
        # Test ChapterCreate -> ORM Model
        chapter_data = ChapterCreate(
            title="Schema Chapter",
            description="From schema",
            project_id=1  # Would need to exist in DB for real usage
        )
        
        chapter_orm = Chapter(**chapter_data.dict(exclude={'project_id'}))
        assert chapter_orm.title == "Schema Chapter"
        assert chapter_orm.description == "From schema"